# Лабораторная работа №2 - Написание _Dockerfile_ 

## Цель работы

Правильно писать _Dockerfile_ и понимать основные практики и антипрактики в работе с контейнерами.

## Ход работы

### Плохой Dockerfile

Начнем с создания "плохого" _Dockerfile_ и потом исправим его, а также разберём все ошибки.

```dockerfile
# Базовый образ без указания версии
FROM nginx

# Копирование всех файлов в корень образа
COPY . /

# Отсутствие очистки и минимизации установки пакетов
RUN apt-get update && \
    apt-get install -y curl && \
    apt-get install -y vim

# Неправильное использование CMD
CMD nginx -g "daemon off;"
```

1. **Базовый образ без указания версии:** Использование фиксированной версии базы позволяет избежать неожиданных 
изменений и проблем с совместимостью при обновлении образа.

2. **Копирование всех файлов в корень образа:** Копирование всех файлов увеличивает размер образа и может привести к 
добавлению ненужных файлов в контейнер.

3. **Отсутствие очистки и минимизации установки пакетов:** Установка лишних пакетов и отсутствие очистки кеша 
увеличивает размер образа и создает уязвимости.
   
4. **Неправильное использование CMD:** Используя форму строкового значения, `Nginx` может не правильно интерпретировать 
аргументы.

### Корректный Dockerfile

Теперь исправим наш _Dockerfile_ и разберём ошибки.

```dockerfile
# Использование конкретной версии базового образа
FROM nginx:1.21.3-alpine

# Установка рабочей директории
WORKDIR /usr/share/nginx/html

# Копирование только нужных файлов
COPY index.html .

# Минимизация установки пакетов и очистка кеша
RUN apk add --no-cache curl

# Правильное использование CMD
CMD ["nginx", "-g", "daemon off;"]
```

1. **Базовый образ без указания версии:** Указание конкретной версии `nginx:1.21.3-alpine` в базовом образе. 
Образ станет стабильным и предсказуемым, так как изменения в новой версии образа не будут неожиданными.

2. **Копирование всех файлов в корень образа:** Копирование только необходимых файлов `index.html` в соответствующую 
директорию. Размер образа уменьшится, улучшится защищенность и управляемость файлами.

3. **Отсутствие очистки и минимизации установки пакетов:** Установка минимального набора пакетов с очисткой кеша 
`apk add --no-cache curl`. Способствует уменьшению размера образа и улучшению безопасности за счет минимизации ненужных 
файлов и пакетов.

4. **Неправильное использование CMD:** Применение массива строк для `CMD ["nginx", "-g", "daemon off;"]`. Улучшает 
предсказуемость выполнения команды.

### Плохие практики при работе с контейнерами:

1. **Игнорирование мониторинга и логирования контейнеров:** Может привести к ситуациям, когда вы не знаете о проблемах 
в ваших контейнерах до тех пор, пока они не нанесут серьезный ущерб. Используйте инструменты, такие как `Prometheus` 
и `Grafana` для мониторинга метрик, и `ELK (Elasticsearch, Logstash, Kibana)` для сбора и анализа логов. Также можно 
использовать встроенные возможности `Docker` для логирования и мониторинга с помощью драйверов логов и встроенных команд.

2. **Недостаточная изоляция между контейнерами:** Недостаточная изоляция между контейнерами может привести к пересечению 
ресурсов и проблемам с безопасностью. Контейнеры могут случайно или намеренно получить доступ к ресурсам или данным 
других контейнеров. Создавайте сети, которые ограничивают доступ контейнеров друг к другу, и настраивайте правила 
межсетевого экранирования `firewall`.

## Вывод

Правильное написание _Dockerfile_ и грамотное управление контейнерами являются критически важными навыками для 
деплоя микросервисов. Эти позволяет создать более стабильные, безопасные и производительные образы контейнеров, а 
также упрощают их управление и поддержку в реальной среде.

[назад](../DOCKER.md) | [меню](../../README.md) | [вперёд](../lab_2*/REPORT.md)
