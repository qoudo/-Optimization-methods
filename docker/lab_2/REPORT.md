# Лабораторная работа №2 - Написание Dockerfile 

## Цель работы

Правильно писать `Dockerfile` и понимать основные практики и антипрактики в работе с контейнерами.

## Ход работы

### Плохой Dockerfile

Начнем с создания "плохого" `Dockerfile` и потом исправим его, а также разберём все ошибки.

```dockerfile
# Базовый образ без указания версии
FROM nginx

# Копирование всех файлов в корень образа
COPY . /

# Отсутствие очистки и минимизации установки пакетов
RUN apt-get update && \
    apt-get install -y curl && \
    apt-get install -y vim

# Неправильное использование CMD
CMD nginx -g "daemon off;"
```


1. **Базовый образ без указания версии:** Использование фиксированной версии базы позволяет избежать неожиданных 
изменений и проблем с совместимостью при обновлении образа.

2. **Копирование всех файлов в корень образа:** Копирование всех файлов увеличивает размер образа и может привести к 
добавлению ненужных файлов в контейнер.

3. **Отсутствие очистки и минимизации установки пакетов:** Установка лишних пакетов и отсутствие очистки кеша 
увеличивает размер образа и создает уязвимости.
   
4. **Неправильное использование CMD:** Используя форму строкового значения, `Nginx` может не правильно интерпретировать 
аргументы.

### Плохой Dockerfile

Теперь исправим наш `Dockerfile` и разберём ошибки.

```dockerfile
# Использование конкретной версии базового образа
FROM nginx:1.21.3-alpine

# Установка рабочей директории
WORKDIR /usr/share/nginx/html

# Копирование только нужных файлов
COPY index.html .

# Минимизация установки пакетов и очистка кеша
RUN apk add --no-cache curl

# Правильное использование CMD
CMD ["nginx", "-g", "daemon off;"]
```

1. **Базовый образ без указания версии:** Указание конкретной версии `nginx:1.21.3-alpine` в базовом образе. 
Образ стал стабильным и предсказуемым, так как изменения в новой версии образа не будут неожиданными.

2. **Копирование всех файлов в корень образа:** Копирование только необходимых файлов `index.html`) в соответствующую 
директорию. Размер образа уменьшился, улучшилась защищенность и управляемость файлами.

3. **Отсутствие очистки и минимизации установки пакетов:** Установка минимального набора пакетов с очисткой кеша 
`apk add --no-cache curl`. Уменьшение размера образа и улучшение безопасности за счет минимизации ненужных файлов 
и пакетов.

4. **Неправильное использование CMD:** Применение массива строк для `CMD ["nginx", "-g", "daemon off;"]`. 
Убедившись, что CMD анализируется корректно, улучшена предсказуемость выполнения команды.

### Плохие практики при работе с контейнерами:

1. **Запуск контейнеров с привилегиями:**
    - **Плохо:** Контейнеры с привилегиями получают больше прав на уровне хоста, что может привести к 
утечке данных или захвату системы в случае уязвимости.
    - **Хорошо** Не используйте флаг `--privileged` без крайней необходимости. По возможности, запускайте 
контейнеры от имени не-root пользователя с флагом `--user`.

2. **Неуправляемое количество контейнеров:**
    - **Плохо**: Оставленные неиспользуемые и остановленные контейнеры могут занимать значительное 
количество дискового пространства, что усложняет управление.
    - **Хорошо:** Регулярно очищайте неиспользуемые контейнеры. Используйте команды `docker ps -a` для просмотра 
всех контейнеров и `docker rm <container_id>` для удаления ненужных, а также `docker system prune` для общей очистки.

## Вывод

Правильное написание `Dockerfile` и грамотное управление контейнерами являются критически важными навыками для 
деплоя микросервисов. Эти позволяет создать более стабильные, безопасные и производительные образы контейнеров, а 
также упрощают их управление и поддержку в реальной среде.

[назад](../DOCKER.md) | [меню](../../README.md) | [вперёд](../lab_2*/REPORT.md)
